//Copyright (c) 2014 by Disy Informationssysteme GmbH
package net.disy.eenvplus.tfes.core.config.data.xml;

import net.disy.eenvplus.tfes.core.config.data.DataSourceConfiguration;
import net.disy.eenvplus.tfes.core.schema.XmlDataSource;

import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.beans.factory.support.AbstractBeanDefinition;
import org.springframework.beans.factory.support.BeanDefinitionBuilder;
import org.springframework.beans.factory.xml.AbstractBeanDefinitionParser;
import org.springframework.beans.factory.xml.ParserContext;
import org.w3c.dom.Element;

// NOT_PUBLISHED
public class DataSourceConfigurationParser extends AbstractBeanDefinitionParser {

  private static final String CONFIGURATION_SUFFIX = "Configuration"; //$NON-NLS-1$

  @Override
  protected AbstractBeanDefinition parseInternal(
      Element dataSourceElement,
      ParserContext parserContext) {
    final XmlDataSource dataSource = JaxbHelper.unmarshal(dataSourceElement);
    BeanDefinition definition = createBeanDefinition(dataSource);
    String name = createName(dataSource);
    parserContext.getRegistry().registerBeanDefinition(name, definition);
    return null;
  }

  private AbstractBeanDefinition createBeanDefinition(final XmlDataSource dataSource) {
    return BeanDefinitionBuilder
        .rootBeanDefinition(DataSourceConfiguration.class)
        .addPropertyValue(DataSourceConfiguration.NAME, dataSource.getName())
        .addPropertyValue(DataSourceConfiguration.ONLINE_RESOURCE, dataSource.getOnlineResource())
        .addPropertyValue(
            DataSourceConfiguration.LANGUAGES,
            dataSource.getSupportedLanguages().getLanguage())
        .getBeanDefinition();
  }

  private String createName(final XmlDataSource dataSource) {
    return dataSource.getName() + CONFIGURATION_SUFFIX;
  }

}
