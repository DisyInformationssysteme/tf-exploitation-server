//Copyright (c) 2014 by Disy Informationssysteme GmbH
package net.disy.eenvplus.tfes.web.logging;

import static net.disy.eenvplus.tfes.web.logging.RequestLogger.TFES_REQUEST_ID;
import static org.springframework.web.context.request.RequestAttributes.SCOPE_REQUEST;

import java.util.UUID;

import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.After;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestAttributes;
import org.springframework.web.context.request.RequestContextHolder;

// NOT_PUBLISHED
@Aspect
@Component
public class ServiceLoggingAspect {

  @Before("@within(org.springframework.stereotype.Service)")
  public void logStartServiceCall(final JoinPoint joinPoint) {
    Logger logger = LoggerFactory.getLogger(joinPoint.getTarget().getClass());
    if (logger.isTraceEnabled()) {
      logger
          .trace("Calling: " + joinPoint.getSignature().getName() + " for Request: " + getRequestId()); //$NON-NLS-1$ //$NON-NLS-2$
    }
  }

  private UUID getRequestId() {
    RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();
    return (UUID) requestAttributes.getAttribute(TFES_REQUEST_ID, SCOPE_REQUEST);
  }

  @After("@within(org.springframework.stereotype.Service)")
  public void logEndServiceCall(final JoinPoint joinPoint) {
    Logger logger = LoggerFactory.getLogger(joinPoint.getTarget().getClass());
    if (logger.isTraceEnabled()) {
      logger
          .trace("Returning: " + joinPoint.getSignature().getName() + " for Request: " + getRequestId()); //$NON-NLS-1$ //$NON-NLS-2$
    }
  }

}
