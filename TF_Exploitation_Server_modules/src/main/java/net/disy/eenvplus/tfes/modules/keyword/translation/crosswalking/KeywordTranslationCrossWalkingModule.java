//Copyright (c) 2014 by Disy Informationssysteme GmbH
package net.disy.eenvplus.tfes.modules.keyword.translation.crosswalking;

import static net.disy.eenvplus.tfes.modules.keyword.translation.crosswalking.SynonymsCrossWalkingQueryBuilder.createSynonymsQuery;

import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.Callable;

import net.disy.eenvplus.tfes.core.api.capabilities.ParameterDescription;
import net.disy.eenvplus.tfes.core.api.capabilities.ServiceModuleDescription;
import net.disy.eenvplus.tfes.core.api.modules.ISynonymProviderServiceModule;
import net.disy.eenvplus.tfes.core.api.query.ISynonymQuery;
import net.disy.eenvplus.tfes.core.api.response.ISynonym;
import net.disy.eenvplus.tfes.modules.core.ISparqlConnector;
import net.disy.eenvplus.tfes.modules.keyword.translation.SynonymsResultSetMapper;

import org.springframework.beans.factory.annotation.Autowired;

import com.hp.hpl.jena.query.Query;
import com.hp.hpl.jena.query.ResultSet;

// NOT_PUBLISHED

public class KeywordTranslationCrossWalkingModule implements ISynonymProviderServiceModule {

  @Autowired
  private ISparqlConnector sparqlConnector;

  static final String SERVICE_ID = "Keyword Translation Cross Walking Module"; //$NON-NLS-1$
  static final String SOURCE_LABEL = "source_label"; //$NON-NLS-1$

  @Override
  public ServiceModuleDescription getDescription() {
    List<ParameterDescription> parameterDescriptions = Collections.emptyList();
    return new ServiceModuleDescription(SERVICE_ID, parameterDescriptions);
  }

  @Override
  public Callable<Collection<ISynonym>> getSynonyms(final ISynonymQuery query) {
    return new Callable<Collection<ISynonym>>() {

      @Override
      public Collection<ISynonym> call() throws Exception {
        if (!query.isCrossWalkingActive()) {
          return Collections.emptyList();
        }
        Query jenaQuery = createSynonymsQuery(query.getConcept(), SOURCE_LABEL)
            .withLimit(query.getMaxCount())
            .withSchemas(query.getThesauri())
            .withLanguages(query.getLanguages())
            .withSource(query.isSourceActive())
            .build();
        ResultSet resultSet = sparqlConnector.executeSparqlQuery(jenaQuery);

        return SynonymsResultSetMapper.create(SOURCE_LABEL).map(resultSet);
      }
    };
  }

}
