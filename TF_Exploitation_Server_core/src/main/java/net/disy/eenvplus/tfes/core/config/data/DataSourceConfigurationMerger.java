//Copyright (c) 2014 by Disy Informationssysteme GmbH
package net.disy.eenvplus.tfes.core.config.data;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;

import net.disy.eenvplus.tfes.core.api.capabilities.IDataSourceConfiguration;

// NOT_PUBLISHED

public class DataSourceConfigurationMerger {
  private Map<String, IDataSourceConfiguration> sources = new HashMap<>();

  public DataSourceConfigurationMerger add(Collection<IDataSourceConfiguration> toAdd) {
    for (IDataSourceConfiguration current : toAdd) {
      IDataSourceConfiguration previous = sources.get(current.getOnlineResource());
      sources.put(current.getOnlineResource(), merge(current, previous));
    }
    return this;
  }

  public Collection<IDataSourceConfiguration> getSources() {
    return sources.values();
  }

  private IDataSourceConfiguration merge(
      IDataSourceConfiguration current,
      IDataSourceConfiguration previous) {
    if (previous == null) {
      return current;
    }
    DataSourceConfiguration merged = new DataSourceConfiguration();
    merged.setOnlineResource(previous.getOnlineResource());
    merged.setName(previous.getName());
    merged.setLanguages(getMergedLanguages(current, previous));
    merged.setRank(previous.getRank());
    return merged;
  }

  private List<String> getMergedLanguages(
      IDataSourceConfiguration current,
      IDataSourceConfiguration previous) {
    Set<String> languages = new TreeSet<>(previous.getLanguages());
    languages.addAll(current.getLanguages());
    return new ArrayList<>(languages);
  }

}
