//Copyright (c) 2015 by Disy Informationssysteme GmbH
package net.disy.eenvplus.tfes.web.logging;

import static org.apache.commons.lang3.StringUtils.isNotBlank;

import java.util.UUID;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

// NOT_PUBLISHED
@Component
public class RequestLogger implements HandlerInterceptor {

  public static final String TFES_REQUEST_ID = "TFES_REQUEST_ID"; //$NON-NLS-1$
  private static final Logger LOG = LoggerFactory.getLogger(RequestLogger.class);

  @Override
  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
      throws Exception {
    UUID requestId = UUID.randomUUID();
    request.setAttribute(TFES_REQUEST_ID, requestId);
    StringBuilder builder = new StringBuilder("Starting exection of request: " + requestId + "\n"); //$NON-NLS-1$ //$NON-NLS-2$

    LOG.trace(appendQueryString(builder, request).toString());
    return true;
  }

  private StringBuilder appendQueryString(StringBuilder builder, HttpServletRequest request) {
    builder.append(request.getRequestURI());
    if (isNotBlank(request.getQueryString())) {
      builder.append("?"); //$NON-NLS-1$
      builder.append(request.getQueryString());
    }
    return builder;

  }

  @Override
  public void postHandle(
      HttpServletRequest request,
      HttpServletResponse response,
      Object handler,
      ModelAndView modelAndView) throws Exception {
  }

  @Override
  public void afterCompletion(
      HttpServletRequest request,
      HttpServletResponse response,
      Object handler,
      Exception ex) throws Exception {
    Object requestId = request.getAttribute(TFES_REQUEST_ID);
    LOG.trace("Finished execution of request: " + requestId + " Status: " + response.getStatus()); //$NON-NLS-1$ //$NON-NLS-2$
  }
}
