//Copyright (c) 2014 by Disy Informationssysteme GmbH
package net.disy.eenvplus.tfes.web.endpoint.controller;

import static java.util.Collections.emptyList;
import static net.disy.eenvplus.tfes.web.api.core.RestMethodParameters.CONCEPT;
import static net.disy.eenvplus.tfes.web.api.core.RestMethodParameters.CROSS_WALKING;
import static net.disy.eenvplus.tfes.web.api.core.RestMethodParameters.EXTRA_PARAMS;
import static net.disy.eenvplus.tfes.web.api.core.RestMethodParameters.LANGUAGES;
import static net.disy.eenvplus.tfes.web.api.core.RestMethodParameters.MAX_COUNT;
import static net.disy.eenvplus.tfes.web.api.core.RestMethodParameters.SERVICE;
import static net.disy.eenvplus.tfes.web.api.core.RestMethodParameters.SOURCE;
import static net.disy.eenvplus.tfes.web.api.core.RestMethodParameters.THESAURI;
import static net.disy.eenvplus.tfes.web.endpoint.query.ServiceQueryBuilder.createRelativesQuery;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

import net.disy.eenvplus.tfes.core.api.exceptions.ServiceException;
import net.disy.eenvplus.tfes.core.api.response.IRelative;
import net.disy.eenvplus.tfes.core.api.service.IServiceManager;
import net.disy.eenvplus.tfes.web.api.core.RestMethodParameters;
import net.disy.eenvplus.tfes.web.api.rest.RestApiRelatedKeywordObject;
import net.disy.eenvplus.tfes.web.api.rest.RestApiRelationObject;
import net.disy.eenvplus.tfes.web.api.rest.RestApiRelatives;
import net.disy.eenvplus.tfes.web.endpoint.converter.RestApiKeywordConverter;
import net.disy.eenvplus.tfes.web.endpoint.core.ISelfDescribingOperation;
import net.disy.eenvplus.tfes.web.endpoint.core.OperationDescription;
import net.disy.eenvplus.tfes.web.endpoint.query.ServiceQuery;
import net.disy.eenvplus.tfes.web.validation.api.IRelativeQueryValidator;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.env.Environment;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

// NOT_PUBLISHED

@RestController
@RequestMapping("${rest.relatives.path}")
public class GetRelativesController implements ISelfDescribingOperation {

  private static final String PATH_GET_RELATIVES = "rest.relatives.path"; //$NON-NLS-1$

  @Autowired
  IServiceManager serviceManager;

  @Autowired
  private Environment environment;

  @Autowired
  private IRelativeQueryValidator queryValidator;

  @Autowired
  RestApiKeywordConverter restApiKeywordConverter;

  @Override
  public OperationDescription getOperationDescription() {
    return OperationDescription.Builder
        .createDescriptionFor(
            environment.getProperty(PATH_GET_RELATIVES),
            environment.getProperty(PATH_GET_RELATIVES))
        .withRequestMethod(RequestMethod.GET)
        .withServiceModules(serviceManager.getRelativesDescriptions())
        .withStringParameter(RestMethodParameters.CONCEPT)
        .withIntegerParameter(MAX_COUNT)
        .withStringParameter(THESAURI)
        .withStringParameter(SERVICE)
        .withStringParameter(LANGUAGES)
        .withBooleanParameter(CROSS_WALKING)
        .withBooleanParameter(SOURCE)
        .build();
  }

  @RequestMapping(method = RequestMethod.GET, produces = "application/json; charset=UTF-8")
  public @ResponseBody RestApiRelatives getRelatives(
      @RequestParam(value = CONCEPT) String concept,
      @RequestParam(value = MAX_COUNT, defaultValue = "0") int maxCount,
      @RequestParam(value = THESAURI, defaultValue = "") String thesauri,
      @RequestParam(value = SERVICE, defaultValue = "") String service,
      @RequestParam(value = LANGUAGES, defaultValue = "") String languages,
      @RequestParam(value = CROSS_WALKING, defaultValue = "false") boolean isCrossWalking,
      @RequestParam(value = SOURCE, defaultValue = "false") boolean isSource,
      @RequestParam(value = EXTRA_PARAMS, defaultValue = "") String extraParams)
      throws ServiceException {
    ServiceQuery query = createRelativesQuery(concept)
        .withMaxCount(maxCount)
        .withThesauri(thesauri)
        .withServiceModules(service)
        .withLanguages(languages)
        .withCrossWalking(isCrossWalking)
        .withSource(isSource)
        .withExtraParameters(extraParams)
        .build();
    queryValidator.validate(query);
    Collection<IRelative> relatives = emptyList();
    relatives = serviceManager.getRelatives(query);
    return createResponse(relatives);
  }

  private RestApiRelatives createResponse(Collection<IRelative> relatives) {
    List<RestApiRelatedKeywordObject> responseObjects = new ArrayList<>(relatives.size());
    for (IRelative relative : relatives) {
      RestApiRelatedKeywordObject temp = new RestApiRelatedKeywordObject();
      temp.setRelation(convertToRelationObject(relative));
      temp.setKeyword(restApiKeywordConverter.convert(relative));
      responseObjects.add(temp);
    }
    RestApiRelatives response = new RestApiRelatives();
    response.getRelatives().addAll(responseObjects);
    return response;
  }

  private RestApiRelationObject convertToRelationObject(IRelative relative) {
    RestApiRelationObject responseRelationObject = new RestApiRelationObject();
    responseRelationObject.setLabel(relative.getRelationLabel());
    responseRelationObject.setRelationUri(relative.getRelationUri());
    return responseRelationObject;
  }
}
